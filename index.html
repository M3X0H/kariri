<script>
(() => {
  const canvas = document.getElementById('bgCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');

  // احترام تفضيل المستخدم لتقليل الحركة
  const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  // نقرأ ألوان الثيم من :root (تتغير تلقائياً لو فعلت الوضع الداكن)
  const cs = getComputedStyle(document.documentElement);
  function col(n){ return cs.getPropertyValue(n).trim() || '#22d3ee'; }
  let C1 = col('--p1'), C2 = col('--p2'), C3 = col('--p3');

  let DPR=1, W=0, H=0, particles=[];
  function resize(){
    DPR = Math.min(window.devicePixelRatio || 1, 2);
    W = canvas.width  = Math.floor(innerWidth * DPR);
    H = canvas.height = Math.floor(innerHeight * DPR);
    canvas.style.width = innerWidth + 'px';
    canvas.style.height= innerHeight + 'px';
    makeParticles();
  }

  function makeParticles(){
    const count = Math.max(28, Math.round((innerWidth * innerHeight) / 16000));
    particles = Array.from({length: count}, () => ({
      x: Math.random()*W,
      y: Math.random()*H,
      r: (Math.random()*1.2 + 0.6) * DPR,
      dx: (Math.random()-.5) * (0.35 + Math.random()*0.25) * DPR,
      dy: (Math.random()-.5) * (0.35 + Math.random()*0.25) * DPR,
      color: [C1,C2,C3][Math.floor(Math.random()*3)]
    }));
  }

  function drawGlow(p){
    const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r*10);
    g.addColorStop(0, p.color);
    g.addColorStop(1, 'transparent');
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r*10, 0, Math.PI*2);
    ctx.fill();
  }

  // أمواج خفيفة تعطي إحساس عمق
  let t = 0;
  function drawWaves(){
    t += 0.0025;
    const rows = 3;
    for(let i=0;i<rows;i++){
      const y = (H/(rows+1))*(i+1) + Math.sin(t*120 + i)*8*DPR;
      ctx.beginPath();
      for(let x=0;x<=W;x+=24*DPR){
        const amp = 10*DPR + i*4*DPR;
        const yy = y + Math.sin(x*0.01 + t*140 + i)*amp;
        ctx.lineTo(x, yy);
      }
      ctx.lineWidth = 1.2*DPR;
      // مزيج لوني ناعم بين ألوان الثيم
      ctx.strokeStyle = i%2 ? C2+'cc' : C1+'cc';
      ctx.stroke();
    }
  }

  function step(){
    // خلفية شفافة (ما نمسح بلون كامل عشان يبقى لطيف)
    ctx.clearRect(0,0,W,H);

    // رسم الجسيمات
    for(const p of particles){
      p.x += p.dx; p.y += p.dy;
      if(p.x < -30*DPR) p.x = W + 30*DPR;
      if(p.x > W + 30*DPR) p.x = -30*DPR;
      if(p.y < -30*DPR) p.y = H + 30*DPR;
      if(p.y > H + 30*DPR) p.y = -30*DPR;
      drawGlow(p);
    }

    // أمواج خفيفة فوق الجسيمات
    ctx.globalAlpha = 0.25;
    drawWaves();
    ctx.globalAlpha = 1;

    if(!reduceMotion) requestAnimationFrame(step);
  }

  // تحديث الألوان عند تغيير الثيم (لو عندك زر تبديل)
  const obs = new MutationObserver(() => {
    C1 = col('--p1'); C2 = col('--p2'); C3 = col('--p3');
  });
  obs.observe(document.documentElement, { attributes:true, attributeFilter:['data-theme'] });

  resize();
  if(!reduceMotion) step();
  addEventListener('resize', resize);
})();
</script>
